<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/base :: layout(~{::content})}">

<div th:fragment="content">

    <div class="max-w-md mx-auto">

        <h2 class="text-2xl font-semibold text-primary mb-6">
            Reset Your Password
        </h2>

        <!-- SUCCESS -->
        <div id="successBox"
             class="hidden mb-4 p-3 bg-green-100 text-green-700 border border-green-300 rounded-md"></div>

        <!-- ERROR -->
        <div id="errorBox"
             class="hidden mb-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-md"></div>

        <form id="resetForm" class="space-y-5">

            <div>
                <label class="font-medium">New Password</label>
                <input type="password" id="newPassword" required
                       class="w-full mt-1 p-3 border rounded-lg focus:ring-primary focus:border-primary" />
            </div>

            <button type="submit"
                    class="w-full bg-primary text-white py-3 rounded-lg hover:bg-indigo-700">
                Reset Password
            </button>

        </form>

    </div>

<script>
// -------------------- GET TOKEN FROM URL --------------------
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get("token");

if (!token) {
    document.getElementById("errorBox").textContent =
        "Invalid or missing reset token.";
    document.getElementById("errorBox").classList.remove("hidden");

    document.getElementById("resetForm").classList.add("hidden");
}

// -------------------- FORM SUBMIT --------------------

document.getElementById("resetForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const newPassword = document.getElementById("newPassword").value;
    const errorBox = document.getElementById("errorBox");
    const successBox = document.getElementById("successBox");

    try {
        const response = await fetch("/api/auth/reset-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, newPassword })
        });

        const text = await response.text();

        if (!response.ok) {
            throw new Error(text);
        }

        // SUCCESS
        successBox.textContent = "Password successfully reset! Redirecting to login...";
        successBox.classList.remove("hidden");
        errorBox.classList.add("hidden");

        setTimeout(() => {
            window.location.href = "/login";
        }, 2000);

    } catch (err) {

        errorBox.textContent = err.message;
        errorBox.classList.remove("hidden");
        successBox.classList.add("hidden");
    }
});
</script>

</html>
